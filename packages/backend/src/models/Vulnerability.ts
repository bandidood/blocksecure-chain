import mongoose, { Document, Schema } from 'mongoose';

export enum VulnerabilitySeverity {
  CRITICAL = 'CRITICAL',
  HIGH = 'HIGH',
  MEDIUM = 'MEDIUM',
  LOW = 'LOW',
  INFORMATIONAL = 'INFORMATIONAL'
}

export enum VulnerabilityStatus {
  PENDING = 'PENDING',
  VERIFIED = 'VERIFIED',
  RESOLVED = 'RESOLVED',
  FALSE_POSITIVE = 'FALSE_POSITIVE'
}

export interface IVulnerability extends Document {
  contractAddress: string;
  vulnerabilityType: string;
  severity: VulnerabilitySeverity;
  status: VulnerabilityStatus;
  description: string;
  location?: {
    file?: string;
    line?: number;
    column?: number;
  };
  impact?: string;
  recommendation?: string;
  reportedBy?: string;
  verifiedBy?: string;
  resolvedAt?: Date;
  onChainId?: number;
  createdAt: Date;
  updatedAt: Date;
}

const VulnerabilitySchema = new Schema<IVulnerability>(
  {
    contractAddress: {
      type: String,
      required: true,
      lowercase: true,
      index: true
    },
    vulnerabilityType: {
      type: String,
      required: true,
      index: true
    },
    severity: {
      type: String,
      enum: Object.values(VulnerabilitySeverity),
      required: true,
      index: true
    },
    status: {
      type: String,
      enum: Object.values(VulnerabilityStatus),
      default: VulnerabilityStatus.PENDING,
      index: true
    },
    description: {
      type: String,
      required: true
    },
    location: {
      file: String,
      line: Number,
      column: Number
    },
    impact: String,
    recommendation: String,
    reportedBy: {
      type: String,
      lowercase: true
    },
    verifiedBy: {
      type: String,
      lowercase: true
    },
    resolvedAt: Date,
    onChainId: {
      type: Number,
      unique: true,
      sparse: true
    }
  },
  {
    timestamps: true
  }
);

// Compound indexes for efficient queries
VulnerabilitySchema.index({ contractAddress: 1, status: 1 });
VulnerabilitySchema.index({ contractAddress: 1, severity: 1 });
VulnerabilitySchema.index({ createdAt: -1 });

export const Vulnerability = mongoose.model<IVulnerability>('Vulnerability', VulnerabilitySchema);
